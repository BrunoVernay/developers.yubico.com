== Prerequisites and Preparation

The audience of this document is expected to be an experienced system administrator with a good
understanding of Windows Server management. In addition, it will be helpful to be familiar with the terminology, software and tools specific to YubiHSM 2. As a primer for these, refer to the Terminology chapter.

In order to follow the steps provided in this guide, be sure you meet the following prerequisites:
•	 Access to Microsoft Windows Server 2012, R2/2016, 2019 with Active Directory in an offline, air-gapped environment, such as a secure computer network that is physically isolated from unsecured
networks such as the internet. You must also have elevated system privileges.
•	 YubiHSM 2 software and tools for Windows have been downloaded from the Yubico Knowledge
Base and are available on the system to be used.
•	 Two (2) factory-reset YubiHSM 2 devices, one for deployment and one for backup in hardware.
•	 Key custodians have been identified as per local requirements and are available to participate. For
more information about the concept of key custodians and the associated ‘m of n’ key shares, see
the following section Understanding Key Splitting and Key Custodians.


=== Installing YubiHSM 2 Tools and Software
You need to download and install the YubiHSM 2 tools and software in order to complete the
procedures in this guide.
TIP: A generic prompt, $, is used in command line examples in this document. Depending on your
command line application, your prompt may be different.
1.	 Download the package for Windows from YubiHSM Libraries and Tools in the Yubico Knowledge
Base. Unzip the archive and move the contents to an appropriate location.
2.	 On your Windows system, run both installers:
• yubihsm-cngprovider-windows-amd64.msi (YubiHSM Key Storage Provider)
• yubihsm-connector-windows-amd64.msi (YubiHSM Connector for Windows)


==== About the YubiHSM Software
The following YubiHSM pieces of software are used in this guide. They are included as part of the
archive file you downloaded from the Yubico Knowledge Base.

:YubiHSM Connector: Facilitates communication between the YubiHSM 2 and applications that use it. Must always be running.

:YubiHSM Shell
yubihsm-shell.exe: The administrative command line tool used to interact with
and configure the YubiHSM 2 device.

:YubiHSM Setup
yubihsm-setup.exe: Helps with setting up a device for specific use cases.
Currently supports setting up for use with KSP/ADCS.

:YubiHSM Key Storage Provider (KSP): Acts like a “driver” for the device on Windows and allows it
to work with applications that leverage Microsoft’s
cryptographic interface, such as Active Directory Certificate
Services.

== Default YubiHSM 2 Device Configuration
The YubiHSM 2 device comes with a default, factory-installed authentication key that has the password
password. As part of the configuration in this guide, the default authentication key will be destroyed.
The device can be reset to its default configuration, destroying any objects stored on the device that
are not factory-installed. This is done while inserting the device into a USB port -- press the metal rim
as you insert the device and continue to press the rim for a minimum of 10 seconds to reset to the
default configuration.
To verify that the YubiHSM is in default configuration
1.	 To gain shell access to the YubiHSM 2, launch the YubiHSM Shell program. To do this, launch your
command line application, navigate to the directory containing the YubiHSM Shell program, run
the command yubihsm-shell and press Enter.
2.	 To connect to the YubiHSM, at the yubihsm command line, type connect and press Enter. A
message verifying that you have a successful connection is displayed.
3.	 To open a session with the YubiHSM 2, type session open 1 (where 1 is the id of the default
authentication key pre-installed on the device) and press Enter.
4.	 Type in the default password: password
You will receive a confirmation message that the session has been set up successfully.
5.	 You now have an administrative connection to the YubiHSM 2 and can list the objects available. To
list the objects, type list objects 0 and press Enter. Your results should be similar to the
following:
id: 0x0001, type: authkey, sequence: 0
6.	 To exit type quit.
Note that you will need two YubiHSM 2 devices to complete all steps of this guide. Specifically, you will
deploy a primary device and also create a backup of all key material onto a secondary device.
Understanding Key Splitting and Key Custodians
The preferred method for setting up YubiHSM 2 to secure Microsoft ADCS described in this guide
involves key splitting and rejoining, often called setting up an ‘m of n’ scheme. This involves splitting a
wrap key among a predetermined number (n) of wrap key custodians (also known as key
shareholders). In order to use the wrap key, a minimum number of shares must be present to rejoin
the wrap key (m). If this number is not present, the wrap key cannot be used.
The process ensures no single person can use the wrap key to export key material off the device, and
also provides a way to control the import of key material that has been exported under wrap from one
device into other devices. The YubiHSM Setup Tool assists in setting up the key splitting and assigning
shares to key custodians. If your organization has policies in place that defines how this procedure
should be performed, be sure you know these policies before proceeding.
To complete the setup process, you need to know who will have the role of wrap key custodians. You
should also have a predetermined practice in place for how the wrap key shares should be recorded
(written on paper, photographed, locally printed, or by some other means) and how they are stored
between use (for example, offsite archive, safe deposit box, sealed envelope). During setup, all wrap
key custodians must be physically present to record, each in turn, their shares. When the wrap key is
subsequently used, the shares required to rejoin the wrap key and the key custodians carrying those
shares, must also be present at the same time in order to use the wrap key. In other words: ‘m’ out of
‘n’ number of shares must be rejoined in order to use the wrap key.

.. image::privacy-threshold.png

*m = Privacy Threshold*

The number, ‘n,’ should be bigger than 1. However, the number and privacy threshold for key shares
ultimately depends on the requirements in your organization.
